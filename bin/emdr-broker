#!/usr/bin/env python
"""
Shell command for starting up the broker that sits behind the gateway,
feeding jobs to the processors.
"""
import argparse
from emdr.conf import default_settings
from emdr.core.command_utils import set_logger_level, print_cmd_footer, print_cmd_header

parser = argparse.ArgumentParser(
    description="The broker connects to a gateway, retrieves un-processed" \
                "orders, and shoves said orders out to processor workers.",
)
parser.add_argument(
    '--gateway', action='append', dest='gateways',
    help="Overrides default broker receiver bindings. This determines where " \
         "the broker gets its messages, typically the gateway.")
parser.add_argument(
    '--listen', action='append', dest='listeners',
    help="Override default broker sender bindings. This determines how " \
         "processor workers will connect to the broker to retrieve new jobs.")
parser.add_argument(
    '--loglevel', action='store', dest='loglevel',
    help="Overrides default logger level (DEBUG, INFO, WARNING, ERROR) (default: %s)" % default_settings.LOGGING['loggers']['']['level'])

parsed = parser.parse_args()

print_cmd_header('emdr-broker')

if parsed.gateways:
    default_settings.BROKER_RECEIVER_BINDINGS = parsed.gateways
    print("* Overriding default broker receiver bindings: %s" % parsed.gateways)
if parsed.listeners:
    default_settings.BROKER_SENDER_BINDINGS = parsed.listeners
    print("* Overriding default broker sender bindings: %s" % parsed.listeners)

if parsed.loglevel:
    set_logger_level(parsed.loglevel)

from emdr.daemons.broker import main

print_cmd_footer()

# Fire up the broker.
main.start()